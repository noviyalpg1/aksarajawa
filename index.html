<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinau Aksara Jawa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+Javanese&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Fredoka', sans-serif; }
        .font-serif { font-family: 'Noto Sans Javanese', 'Javanese Text', serif; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .duration-3000 { transition-duration: 3000ms; }
        
        @keyframes bounce-in {
          0% { transform: scale(0.8); opacity: 0; }
          60% { transform: scale(1.1); opacity: 1; }
          100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-amber-50 min-h-screen text-slate-800 selection:bg-amber-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG Inline Replacement for Lucide) ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const Move = (props) => <IconBase {...props}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></IconBase>;
        const Link = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>;
        const RefreshCcw = (props) => <IconBase {...props}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></IconBase>;
        
        // Icon Fullscreen
        const Maximize = (props) => <IconBase {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></IconBase>;
        const Minimize = (props) => <IconBase {...props}><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" /></IconBase>;


        // --- DATA AKSARA JAWA ---
        const AKSARA_DATA = [
            { id: 1, char: "ꦲ", latin: "Ha", desc: "Hana (Ada)" },
            { id: 2, char: "ꦤ", latin: "Na", desc: "Caraka (Utusan)" },
            { id: 3, char: "ꦕ", latin: "Ca", desc: "Caraka (Utusan)" },
            { id: 4, char: "ꦫ", latin: "Ra", desc: "Caraka (Utusan)" },
            { id: 5, char: "ꦏ", latin: "Ka", desc: "Caraka (Utusan)" },
            { id: 6, char: "ꦢ", latin: "Da", desc: "Data (Punya)" },
            { id: 7, char: "ꦠ", latin: "Ta", desc: "Data (Punya)" },
            { id: 8, char: "ꦱ", latin: "Sa", desc: "Sawala (Perselisihan)" },
            { id: 9, char: "ꦮ", latin: "Wa", desc: "Sawala (Perselisihan)" },
            { id: 10, char: "ꦭ", latin: "La", desc: "Sawala (Perselisihan)" },
            { id: 11, char: "ꦥ", latin: "Pa", desc: "Padha (Sama)" },
            { id: 12, char: "ꦝ", latin: "Dha", desc: "Padha (Sama)" },
            { id: 13, char: "ꦗ", latin: "Ja", desc: "Jayanya (Kuat)" },
            { id: 14, char: "ꦪ", latin: "Ya", desc: "Jayanya (Kuat)" },
            { id: 15, char: "ꦚ", latin: "Nya", desc: "Jayanya (Kuat)" },
            { id: 16, char: "ꦩ", latin: "Ma", desc: "Moga (Mayat/Mati)" },
            { id: 17, char: "ꦒ", latin: "Ga", desc: "Moga (Mayat/Mati)" },
            { id: 18, char: "ꦧ", latin: "Ba", desc: "Bathanga (Menjadi Batang/Mati)" },
            { id: 19, char: "ꦛ", latin: "Tha", desc: "Bathanga (Menjadi Batang/Mati)" },
            { id: 20, char: "ꦔ", latin: "Nga", desc: "Bathanga (Menjadi Batang/Mati)" },
        ];

        // --- LOCAL STORAGE HELPERS ---
        const STORAGE_KEY = 'sinau_aksara_scores';

        const saveScoreToLocal = (newScore) => {
            try {
                const existingScores = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                existingScores.push(newScore);
                existingScores.sort((a, b) => b.score - a.score);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(existingScores));
            } catch (error) {
                console.error("Gagal menyimpan ke localStorage", error);
            }
        };

        const getScoresFromLocal = () => {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (error) {
                console.error("Gagal mengambil data localStorage", error);
                return [];
            }
        };

        // --- UTILS ---
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID'; 
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        };

        const playSoundEffect = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'click') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            }
        };

        // --- COMPONENTS ---

        // Reusable Fullscreen Toggle Component
        const FullScreenButton = ({ className = "" }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);

            useEffect(() => {
                const handleChange = () => {
                    setIsFullscreen(!!document.fullscreenElement);
                };
                document.addEventListener('fullscreenchange', handleChange);
                return () => document.removeEventListener('fullscreenchange', handleChange);
            }, []);

            const toggle = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    document.exitFullscreen();
                }
            };

            return (
                <button 
                    onClick={toggle} 
                    className={`p-2 rounded-full transition-all active:scale-95 flex items-center justify-center ${className}`}
                    title={isFullscreen ? "Keluar Layar Penuh" : "Layar Penuh"}
                >
                    {isFullscreen ? <Minimize size={24} /> : <Maximize size={24} />}
                </button>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [name, setName] = useState('');
            const [kelas, setKelas] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name && kelas) {
                    playSoundEffect('correct');
                    onLogin({ name, kelas });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-amber-50 relative overflow-hidden font-sans">
                    <div className="absolute inset-0 opacity-10 pointer-events-none" 
                         style={{ backgroundImage: 'radial-gradient(#8B4513 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                    
                    {/* Fullscreen Button for Login */}
                    <div className="absolute top-4 right-4 z-20">
                         <FullScreenButton className="bg-white/80 text-amber-800 hover:bg-white shadow-sm" />
                    </div>

                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border-4 border-amber-600 relative z-10 mx-4">
                        <div className="text-center mb-8">
                            <div className="bg-amber-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-amber-600">
                                <span className="text-6xl text-amber-800 font-serif">ꦲ</span>
                            </div>
                            <h1 className="text-3xl font-bold text-amber-900 mb-2">Sugeng Rawuh!</h1>
                            <p className="text-amber-700">Ayo belajar Aksara Jawa bersama</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-amber-900 font-bold mb-2">Jeneng (Nama Lengkap)</label>
                                <input 
                                    type="text" 
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-4 rounded-xl border-2 border-amber-200 focus:border-amber-600 focus:ring-0 text-lg transition-colors bg-amber-50"
                                    placeholder="Contoh: Budi Santoso"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-amber-900 font-bold mb-2">Kelas</label>
                                <input 
                                    type="text" 
                                    value={kelas}
                                    onChange={(e) => setKelas(e.target.value)}
                                    className="w-full p-4 rounded-xl border-2 border-amber-200 focus:border-amber-600 focus:ring-0 text-lg transition-colors bg-amber-50"
                                    placeholder="Ketik kelasmu (misal: 4A, 5B, Umum)"
                                    required
                                />
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2 mt-6"
                            >
                                Mulai Belajar <ArrowRight size={24} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, setView, onLogout }) => {
            return (
                <div className="p-6 max-w-5xl mx-auto">
                    <header className="flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-md border-b-4 border-amber-200">
                        <div className="flex items-center gap-3">
                            <div className="bg-amber-600 text-white p-2 rounded-lg">
                                <User size={24} />
                            </div>
                            <div>
                                <h2 className="font-bold text-amber-900">{user.name}</h2>
                                <p className="text-xs text-amber-600 font-semibold">{user.kelas}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                             <FullScreenButton className="text-amber-600 hover:bg-amber-50" />
                            <button onClick={onLogout} className="text-red-500 hover:bg-red-50 p-2 rounded-full transition" title="Keluar">
                                <LogOut size={24} />
                            </button>
                        </div>
                    </header>

                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-amber-900 mb-2 font-serif">Sinau Aksara</h1>
                        <p className="text-amber-700">Pilih menu di bawah untuk memulai petualanganmu!</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <MenuCard 
                            title="Sinau (Belajar)" 
                            icon={<BookOpen size={40} />} 
                            color="bg-emerald-500" 
                            onClick={() => setView('learn')} 
                            desc="Kenalan dengan 20 huruf Aksara Jawa"
                        />
                        <MenuCard 
                            title="Ujian (Kuis)" 
                            icon={<Star size={40} />} 
                            color="bg-rose-500" 
                            onClick={() => setView('quiz')} 
                            desc="Uji kemampuanmu & raih skor tertinggi!"
                        />
                        <MenuCard 
                            title="Papan Skor" 
                            icon={<Trophy size={40} />} 
                            color="bg-amber-500" 
                            onClick={() => setView('leaderboard')} 
                            desc="Lihat rangking teman-temanmu"
                        />
                    </div>
                </div>
            );
        };

        const MenuCard = ({ title, icon, color, onClick, desc }) => (
            <button 
                onClick={() => { playSoundEffect('click'); onClick(); }}
                className={`${color} text-white p-6 rounded-3xl shadow-xl hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 text-left relative overflow-hidden group`}
            >
                <div className="absolute right-[-20px] top-[-20px] opacity-20 transform rotate-12 group-hover:scale-110 transition-transform">
                    {icon}
                </div>
                <div className="relative z-10">
                    <div className="bg-white/20 w-16 h-16 rounded-2xl flex items-center justify-center mb-4 backdrop-blur-sm">
                        {icon}
                    </div>
                    <h3 className="text-2xl font-bold mb-1">{title}</h3>
                    <p className="text-white/90 text-sm font-medium">{desc}</p>
                </div>
            </button>
        );

        const LearnMode = ({ onBack }) => {
            const [selectedChar, setSelectedChar] = useState(null);

            return (
                <div className="p-4 max-w-6xl mx-auto min-h-screen flex flex-col">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="bg-white p-3 rounded-xl shadow text-amber-600 hover:bg-amber-50">
                                <Home size={24} />
                            </button>
                            <h2 className="text-2xl font-bold text-amber-900">Materi Aksara Jawa</h2>
                        </div>
                         <FullScreenButton className="bg-white p-3 rounded-xl shadow text-amber-600 hover:bg-amber-50" />
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4 mb-8">
                        {AKSARA_DATA.map((item) => (
                            <div 
                                key={item.id}
                                onClick={() => { playSoundEffect('click'); setSelectedChar(item); speak(item.latin); }}
                                className="bg-white p-4 rounded-2xl shadow-md border-b-4 border-amber-200 hover:border-amber-400 cursor-pointer flex flex-col items-center justify-center aspect-square transition-all hover:bg-amber-50"
                            >
                                <span className="text-4xl sm:text-5xl mb-2 text-amber-900 font-serif">{item.char}</span>
                                <span className="font-bold text-amber-600">{item.latin}</span>
                            </div>
                        ))}
                    </div>

                    {selectedChar && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={() => setSelectedChar(null)}>
                            <div 
                                className="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl animate-bounce-in relative"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <button 
                                    onClick={() => setSelectedChar(null)} 
                                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500"
                                >
                                    <XCircle size={32} />
                                </button>
                                
                                <div className="mb-6 bg-amber-50 rounded-2xl p-8 border-2 border-dashed border-amber-300">
                                    <span className="text-9xl text-amber-900 font-serif block mb-4">{selectedChar.char}</span>
                                </div>
                                
                                <h3 className="text-4xl font-bold text-amber-800 mb-2">{selectedChar.latin}</h3>
                                <p className="text-gray-500 mb-8 italic">{selectedChar.desc}</p>
                                
                                <button 
                                    onClick={() => speak(selectedChar.latin)}
                                    className="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg transform active:scale-95 transition"
                                >
                                    <Volume2 size={24} /> Dengarkan Bunyi
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const QuizMode = ({ user, onBack, onFinishQuiz }) => {
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showFeedback, setShowFeedback] = useState(null); 
            const [quizFinished, setQuizFinished] = useState(false);
            const [timeElapsed, setTimeElapsed] = useState(0);
            
            const [ddUserAnswer, setDdUserAnswer] = useState([]);
            const [matchingSelected, setMatchingSelected] = useState(null);
            const [matchingPairs, setMatchingPairs] = useState({});

            const timerRef = useRef(null);

            useEffect(() => {
                generateQuestions();
                timerRef.current = setInterval(() => {
                    setTimeElapsed(prev => prev + 1);
                }, 1000);
                return () => clearInterval(timerRef.current);
            }, []);

            const generateQuestions = () => {
                const q = [];
                // 1. Multiple Choice (5 Soal)
                for (let i = 0; i < 5; i++) {
                    const correctItem = AKSARA_DATA[Math.floor(Math.random() * AKSARA_DATA.length)];
                    let wrongItems = [];
                    while (wrongItems.length < 3) {
                        const item = AKSARA_DATA[Math.floor(Math.random() * AKSARA_DATA.length)];
                        if (item.id !== correctItem.id && !wrongItems.find(w => w.id === item.id)) {
                            wrongItems.push(item);
                        }
                    }
                    q.push({
                        type: 'mc',
                        subType: Math.random() > 0.5 ? 'latin_to_aksara' : 'aksara_to_latin',
                        correct: correctItem,
                        options: [correctItem, ...wrongItems].sort(() => 0.5 - Math.random())
                    });
                }

                // 2. Drag and Drop (3 Soal)
                for (let i = 0; i < 3; i++) {
                    const seq = [];
                    while (seq.length < 3) {
                        const item = AKSARA_DATA[Math.floor(Math.random() * AKSARA_DATA.length)];
                        if (!seq.find(s => s.id === item.id)) seq.push(item);
                    }
                    q.push({
                        type: 'dd',
                        sequence: seq,
                        pool: [...seq].sort(() => 0.5 - Math.random())
                    });
                }

                // 3. Matching (2 Soal)
                for (let i = 0; i < 2; i++) {
                    const pairs = [];
                    while (pairs.length < 3) {
                        const item = AKSARA_DATA[Math.floor(Math.random() * AKSARA_DATA.length)];
                        if (!pairs.find(p => p.id === item.id)) pairs.push(item);
                    }
                    q.push({
                        type: 'mt',
                        pairs: pairs,
                        leftSide: [...pairs].sort(() => 0.5 - Math.random()), 
                        rightSide: [...pairs].sort(() => 0.5 - Math.random()) 
                    });
                }
                setQuestions(q.sort(() => 0.5 - Math.random()));
            };

            const handleNext = (isCorrect) => {
                if (isCorrect) {
                    playSoundEffect('correct');
                    setScore(s => s + 10);
                    setShowFeedback('correct');
                } else {
                    playSoundEffect('wrong');
                    setShowFeedback('wrong');
                }

                setTimeout(() => {
                    setShowFeedback(null);
                    setDdUserAnswer([]);
                    setMatchingPairs({});
                    setMatchingSelected(null);
                    
                    if (currentIndex < 9) {
                        setCurrentIndex(c => c + 1);
                    } else {
                        finishQuiz();
                    }
                }, 1500);
            };

            const finishQuiz = () => {
                clearInterval(timerRef.current);
                setQuizFinished(true);
                onFinishQuiz(score + (showFeedback === 'correct' ? 10 : 0), timeElapsed);
            };

            // Handlers Drag Drop
            const handleDdSelect = (item) => {
                if (ddUserAnswer.length < 3) {
                    playSoundEffect('click');
                    setDdUserAnswer([...ddUserAnswer, item]);
                }
            };
            
            const handleDdRemove = (index) => {
                playSoundEffect('click');
                const newAns = [...ddUserAnswer];
                newAns.splice(index, 1);
                setDdUserAnswer(newAns);
            };

            const checkDdAnswer = () => {
                const currentQ = questions[currentIndex];
                const isCorrect = ddUserAnswer.every((item, idx) => item.id === currentQ.sequence[idx].id) && ddUserAnswer.length === 3;
                handleNext(isCorrect);
            };

            // Handlers Matching
            const handleMatchingClick = (item, side) => {
                if (side === 'left' && matchingPairs[item.id]) return;
                if (side === 'right' && Object.values(matchingPairs).includes(item.id)) return;

                playSoundEffect('click');

                if (!matchingSelected) {
                    setMatchingSelected({ id: item.id, side });
                } else {
                    if (matchingSelected.side === side) {
                        setMatchingSelected({ id: item.id, side });
                    } else {
                        const leftId = side === 'left' ? item.id : matchingSelected.id;
                        const rightId = side === 'right' ? item.id : matchingSelected.id;

                        if (leftId === rightId) {
                            const newPairs = { ...matchingPairs, [leftId]: rightId };
                            setMatchingPairs(newPairs);
                            setMatchingSelected(null);
                            playSoundEffect('correct'); 
                            if (Object.keys(newPairs).length === 3) {
                                setTimeout(() => handleNext(true), 500);
                            }
                        } else {
                            playSoundEffect('wrong');
                            setMatchingSelected(null);
                        }
                    }
                }
            };

            if (questions.length === 0) return <div>Loading...</div>;

            if (quizFinished) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-amber-50 p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-t-8 border-amber-500">
                            <Trophy size={64} className="mx-auto text-amber-500 mb-4" />
                            <h2 className="text-3xl font-bold text-amber-900 mb-2">Kuis Selesai!</h2>
                            <p className="text-gray-500 mb-6">Kerja bagus, {user.name}!</p>
                            <div className="bg-amber-100 rounded-2xl p-6 mb-6">
                                <div className="text-sm text-amber-700 uppercase font-bold tracking-wider mb-1">Skor Kamu</div>
                                <div className="text-5xl font-bold text-amber-800">{score}</div>
                            </div>
                            <button onClick={onBack} className="w-full bg-amber-600 text-white font-bold py-3 rounded-xl hover:bg-amber-700 transition shadow-lg">
                                Kembali ke Menu
                            </button>
                        </div>
                    </div>
                );
            }

            const currentQ = questions[currentIndex];
            
            return (
                <div className="p-4 max-w-2xl mx-auto min-h-screen flex flex-col">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="bg-white p-2 rounded-xl shadow-sm text-amber-600 hover:bg-amber-50 border border-amber-200">
                                <Home size={24} />
                            </button>
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 rounded-full bg-white border-2 border-amber-300 flex items-center justify-center font-bold text-amber-700">
                                    {currentIndex + 1}
                                </div>
                                <span className="text-gray-400 text-sm">/ 10</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                             <div className="bg-white px-4 py-2 rounded-full shadow-sm text-amber-800 font-bold border border-amber-100">
                                Skor: {score}
                            </div>
                            <FullScreenButton className="bg-white p-2 rounded-xl shadow-sm text-amber-600 hover:bg-amber-50 border border-amber-200" />
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-xl p-6 mb-4 flex-grow flex flex-col relative overflow-hidden border-b-8 border-amber-100">
                        {showFeedback && (
                            <div className={`absolute inset-0 flex items-center justify-center z-20 bg-opacity-90 ${showFeedback === 'correct' ? 'bg-green-100' : 'bg-red-100'}`}>
                                {showFeedback === 'correct' ? 
                                    <CheckCircle size={80} className="text-green-500 animate-bounce" /> : 
                                    <XCircle size={80} className="text-red-500 animate-pulse" />
                                }
                            </div>
                        )}

                        {currentQ.type === 'mc' && (
                            <div className="flex flex-col h-full justify-center">
                                <h3 className="text-xl text-gray-500 mb-6 font-medium text-center">
                                    {currentQ.subType === 'latin_to_aksara' ? "Manakah aksara Jawa untuk:" : "Apa bunyi aksara Jawa ini:"}
                                </h3>
                                <div className="mb-8 text-center">
                                    <span className={`font-bold ${currentQ.subType === 'aksara_to_latin' ? 'text-8xl font-serif text-amber-900' : 'text-5xl text-amber-800'}`}>
                                        {currentQ.subType === 'latin_to_aksara' ? currentQ.correct.latin : currentQ.correct.char}
                                    </span>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    {currentQ.options.map((opt) => (
                                        <button
                                            key={opt.id}
                                            onClick={() => handleNext(opt.id === currentQ.correct.id)}
                                            disabled={showFeedback !== null}
                                            className="bg-white p-6 rounded-2xl shadow-md border-2 border-amber-100 hover:border-amber-400 hover:bg-amber-50 transition-all active:scale-95 flex items-center justify-center min-h-[80px]"
                                        >
                                            <span className={`font-bold ${currentQ.subType === 'latin_to_aksara' ? 'text-4xl font-serif text-amber-900' : 'text-xl text-amber-800'}`}>
                                                {currentQ.subType === 'latin_to_aksara' ? opt.char : opt.latin}
                                            </span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {currentQ.type === 'dd' && (
                            <div className="flex flex-col h-full">
                                <div className="flex items-center gap-2 mb-4 text-amber-700 font-bold">
                                    <Move size={20} /> <span className="text-lg">Susun Kata</span>
                                </div>
                                <div className="text-center mb-6">
                                    <p className="text-gray-500 mb-2">Susun aksara menjadi urutan:</p>
                                    <h3 className="text-3xl font-bold text-amber-800 bg-amber-100 inline-block px-4 py-2 rounded-lg">
                                        {currentQ.sequence.map(s => s.latin).join(" - ")}
                                    </h3>
                                </div>

                                <div className="flex justify-center gap-3 mb-8">
                                    {[0, 1, 2].map((idx) => {
                                        const filled = ddUserAnswer[idx];
                                        return (
                                            <div 
                                                key={idx}
                                                onClick={() => filled && handleDdRemove(idx)}
                                                className={`w-20 h-20 sm:w-24 sm:h-24 rounded-2xl border-4 border-dashed flex items-center justify-center cursor-pointer transition-all
                                                    ${filled ? 'bg-white border-amber-500 shadow-lg' : 'bg-gray-50 border-gray-300'}`}
                                            >
                                                {filled ? (
                                                    <span className="text-4xl sm:text-5xl font-serif text-amber-900">{filled.char}</span>
                                                ) : (
                                                    <span className="text-gray-300 font-bold text-xl">{idx + 1}</span>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="flex flex-wrap justify-center gap-3 mt-auto">
                                    {currentQ.pool.map((item, idx) => {
                                        const isUsed = ddUserAnswer.some(ans => ans.id === item.id); 
                                        return (
                                            <button
                                                key={idx}
                                                onClick={() => !isUsed && handleDdSelect(item)}
                                                disabled={isUsed}
                                                className={`p-4 rounded-xl shadow-md border-2 transition-all transform
                                                    ${isUsed ? 'opacity-30 scale-90 bg-gray-100 border-gray-200' : 'bg-white border-amber-200 hover:border-amber-500 hover:-translate-y-1 active:scale-95'}`}
                                            >
                                                <span className="text-3xl font-serif text-amber-900">{item.char}</span>
                                            </button>
                                        );
                                    })}
                                </div>

                                {ddUserAnswer.length === 3 && (
                                    <button 
                                        onClick={checkDdAnswer}
                                        className="mt-6 w-full bg-amber-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-amber-700 animate-bounce-in"
                                    >
                                        Cek Jawaban
                                    </button>
                                )}
                            </div>
                        )}

                        {currentQ.type === 'mt' && (
                            <div className="flex flex-col h-full">
                                <div className="flex items-center gap-2 mb-4 text-amber-700 font-bold">
                                    <Link size={20} /> <span className="text-lg">Jodohkan Pasangan</span>
                                </div>
                                <p className="text-gray-500 text-center mb-4 text-sm">Klik Aksara, lalu klik Bunyi yang sesuai.</p>
                                
                                <div className="flex justify-between gap-4 h-full">
                                    <div className="flex flex-col gap-3 flex-1">
                                        {currentQ.leftSide.map((item) => {
                                            const isPaired = matchingPairs[item.id];
                                            const isSelected = matchingSelected?.id === item.id && matchingSelected?.side === 'left';
                                            return (
                                                <button
                                                    key={item.id}
                                                    onClick={() => handleMatchingClick(item, 'left')}
                                                    className={`h-20 rounded-xl flex items-center justify-center border-2 transition-all relative
                                                        ${isPaired ? 'bg-green-100 border-green-400 opacity-50' : 
                                                        isSelected ? 'bg-amber-100 border-amber-500 ring-2 ring-amber-300' : 'bg-white border-gray-200 hover:border-amber-300'}`}
                                                >
                                                    <span className="text-3xl font-serif text-amber-900">{item.char}</span>
                                                    {isPaired && <CheckCircle className="absolute right-2 top-2 text-green-500 w-4 h-4" />}
                                                </button>
                                            );
                                        })}
                                    </div>

                                    <div className="flex flex-col gap-3 flex-1">
                                        {currentQ.rightSide.map((item) => {
                                            const isPaired = Object.values(matchingPairs).includes(item.id);
                                            const isSelected = matchingSelected?.id === item.id && matchingSelected?.side === 'right';
                                            return (
                                                <button
                                                    key={item.id}
                                                    onClick={() => handleMatchingClick(item, 'right')}
                                                    className={`h-20 rounded-xl flex items-center justify-center border-2 transition-all relative
                                                        ${isPaired ? 'bg-green-100 border-green-400 opacity-50' : 
                                                        isSelected ? 'bg-amber-100 border-amber-500 ring-2 ring-amber-300' : 'bg-white border-gray-200 hover:border-amber-300'}`}
                                                >
                                                    <span className="text-xl font-bold text-amber-800">{item.latin}</span>
                                                    {isPaired && <CheckCircle className="absolute right-2 top-2 text-green-500 w-4 h-4" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Leaderboard = ({ onBack }) => {
            const [scores, setScores] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Menggunakan LocalStorage
                const localData = getScoresFromLocal();
                setScores(localData.slice(0, 10)); // Top 10
                setLoading(false);
            }, []);

            return (
                <div className="p-4 max-w-2xl mx-auto min-h-screen">
                    <div className="flex items-center justify-between mb-8">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="bg-white p-3 rounded-xl shadow text-amber-600 hover:bg-amber-50">
                                <Home size={24} />
                            </button>
                            <h2 className="text-2xl font-bold text-amber-900">Papan Skor (Lokal)</h2>
                        </div>
                        <FullScreenButton className="bg-white p-3 rounded-xl shadow text-amber-600 hover:bg-amber-50" />
                    </div>

                    <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
                        <div className="bg-amber-500 p-4 flex justify-between text-white font-bold px-6">
                            <span>Siswa</span>
                            <span>Skor</span>
                        </div>
                        
                        {loading ? (
                            <div className="p-8 text-center text-gray-400">Memuat data...</div>
                        ) : (
                            <div className="divide-y divide-gray-100">
                                {scores.length === 0 ? (
                                    <div className="p-8 text-center text-gray-400">Belum ada skor. Jadilah yang pertama!</div>
                                ) : (
                                    scores.map((s, idx) => (
                                        <div key={s.id} className="p-4 px-6 flex items-center justify-between hover:bg-amber-50 transition">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
                                                    ${idx === 0 ? 'bg-yellow-400 text-white' : 
                                                        idx === 1 ? 'bg-gray-300 text-white' :
                                                        idx === 2 ? 'bg-amber-700 text-white' : 'bg-gray-100 text-gray-500'}`}>
                                                    {idx + 1}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-gray-800">{s.name}</div>
                                                    <div className="text-xs text-gray-500">Kelas {s.kelas}</div>
                                                </div>
                                            </div>
                                            <div className="font-mono font-bold text-amber-600 text-lg">
                                                {s.score}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 

            const handleLogin = (userData) => {
                setUser(userData);
                setView('dashboard');
            };

            const handleLogout = () => {
                setUser(null);
                setView('login');
            };

            const handleFinishQuiz = (finalScore, timeElapsed) => {
                const newScore = {
                    id: Date.now(),
                    name: user.name,
                    kelas: user.kelas,
                    score: finalScore,
                    time: timeElapsed,
                    timestamp: new Date().toISOString()
                };
                
                // Simpan ke LocalStorage
                saveScoreToLocal(newScore);

                setTimeout(() => {
                    setView('leaderboard');
                }, 100);
            };

            const renderView = () => {
                if (!user) return <LoginScreen onLogin={handleLogin} />;

                switch (view) {
                    case 'dashboard':
                        return <Dashboard user={user} setView={setView} onLogout={handleLogout} />;
                    case 'learn':
                        return <LearnMode onBack={() => setView('dashboard')} />;
                    case 'quiz':
                        return <QuizMode user={user} onBack={() => setView('dashboard')} onFinishQuiz={handleFinishQuiz} />;
                    case 'leaderboard':
                        return <Leaderboard onBack={() => setView('dashboard')} />;
                    default:
                        return <Dashboard user={user} setView={setView} onLogout={handleLogout} />;
                }
            };

            return (
                <div className="app-container">
                    {renderView()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
